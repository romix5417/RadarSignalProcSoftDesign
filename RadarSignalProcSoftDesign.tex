%---------------------------------------------------------------------
%
%    Project Name: Radar System Signal Process Software Design Discuss
%
%---------------------------------------------------------------------
%
%               created by LuoMin <luomin5417@gmail.com>
%
%                       Last-modified: 2018-12-14
%
%---------------------------------------------------------------------

\documentclass[a4paper,12pt]{report}
\usepackage{etex}
\usepackage{ctex}
%\usepackage{xeCJK}
\usepackage{times}
\usepackage{setspace}
\usepackage{fancyhdr}
\usepackage{graphicx}
\usepackage{wrapfig}
\usepackage{array}  
\usepackage{fontspec,xunicode,xltxtra}
\usepackage{titlesec}
\usepackage{titletoc}
\usepackage[titletoc]{appendix}
\usepackage[top=30mm,bottom=30mm,left=20mm,right=20mm]{geometry}
\usepackage{cite}
\usepackage{listings}
\usepackage{caption,subcaption}
\usepackage[framed,numbered,autolinebreaks,useliterate]{mcode} % 插入代码
\usepackage{xeboiboites}
\usepackage{amsmath,amssymb}
\usepackage{hyperref}
\usepackage{float}

\usepackage{xcolor}
\usepackage{tcolorbox}

\usepackage{enumerate}
\usepackage[font=small,labelsep=space]{caption}
\usepackage{multirow}

\RequirePackage{tkz-network}

\hypersetup{hidelinks}

\XeTeXlinebreaklocale "zh"
\XeTeXlinebreakskip = 0pt plus 1pt minus 0.1pt

%---------------------------------------------------------------------
%	页眉页脚设置
%---------------------------------------------------------------------
\fancypagestyle{plain}{
    \pagestyle{fancy}      %改变章节首页页眉
}

\pagestyle{fancy}
\lhead{\kaishu~宜通华盛~}
\rhead{\kaishu~研发部~}
\cfoot{\thepage}

%---------------------------------------------------------------------
%	章节标题设置
%---------------------------------------------------------------------
\titleformat{\chapter}{\centering\zihao{-1}\heiti}{第\chinese{chapter}章}{1em}{}
\titlespacing{\chapter}{0pt}{*0}{*6}

%---------------------------------------------------------------------
%	摘要标题设置
%---------------------------------------------------------------------
\renewcommand{\abstractname}{\zihao{-3} 摘\quad 要}

%---------------------------------------------------------------------
%	参考文献设置
%---------------------------------------------------------------------
\renewcommand{\bibname}{\zihao{2}{\hspace{\fill}参\hspace{0.5em}考\hspace{0.5em}文\hspace{0.5em}献\hspace{\fill}}}

%---------------------------------------------------------------------
%	引用文献设置为上标
%---------------------------------------------------------------------
\makeatletter
\def\@cite#1#2{\textsuperscript{[{#1\if@tempswa , #2\fi}]}}
\makeatother

%---------------------------------------------------------------------
%	目录页设置
%---------------------------------------------------------------------
\titlecontents{chapter}[0em]{\songti\zihao{-4}}{\thecontentslabel\ }{}
{\hspace{.5em}\titlerule*[4pt]{$\cdot$}\contentspage}
\titlecontents{section}[2em]{\vspace{0.1\baselineskip}\songti\zihao{-4}}{\thecontentslabel\ }{}
{\hspace{.5em}\titlerule*[4pt]{$\cdot$}\contentspage}
\titlecontents{subsection}[4em]{\vspace{0.1\baselineskip}\songti\zihao{-4}}{\thecontentslabel\ }{}
{\hspace{.5em}\titlerule*[4pt]{$\cdot$}\contentspage}

%---------------------------------------------------------------------
%	公式设置
%---------------------------------------------------------------------
%%define the newthem environment
\newboxedtheorem[small box style={fill=blue!20,draw=black, 
    rounded corners},
    big box style={fill=blue!10,draw=orange,thick,rounded corners},
    headfont=\bfseries]%
    {proposition}{公式}{somecounter} 

%---------------------------------------------------------------------
%   生成大纲
%---------------------------------------------------------------------

\begin{document}
%---------------------------------------------------------------------
%	封面设置
%---------------------------------------------------------------------
\begin{titlepage}
    \begin{center}
        
    \includegraphics[width=0.8\textwidth]{figure//etws.png}\\
    \vspace{40mm}
    \textbf{\zihao{2}\kaishu{ETWS-1810雷达信处}}\\[0.8cm]
    \textbf{\zihao{2}\kaishu{软件设计讨论}}\\[3cm]
    
    \vspace{\fill}
    
\setlength{\extrarowheight}{3mm}
{\songti\zihao{3}	
\begin{tabular}{rl}
    
    {\makebox[5\ccwd][s]{部\qquad 门：}}& ~\kaishu 研发部\\
    
    {\makebox[5\ccwd][s]{编\qquad 制：}}& ~\kaishu 罗敏 \\ 

    {\makebox[5\ccwd][s]{版\qquad 本：}}& ~\kaishu 1.0 \\

\end{tabular}
 }\\[2cm]
\vspace{\fill}
\zihao{4}
使用\LaTeX 撰写于\today
    \end{center}	
\end{titlepage}

%---------------------------------------------------------------------
%  摘要页
%---------------------------------------------------------------------
\begin{abstract}
\begin{spacing}{1.5}
    {\zihao{-4}
    本文主要是关于雷达系统自研信号处理分系统软件设计讨论，目的是确定信号处理分系统软件和
    算法处理部分的详细工作。因对于信号处理部分均是从零起步，一个好的实现方案和计划更显的
    尤为重要,本文从信号处理分系统输出目标出发，逐步详细阐述各个设计目标的计算和实现过程。

    \textbf{关键字}：\quad 雷达系统 \quad 信号处理 \quad 算法 \quad 实现
    }
\end{spacing}
\end{abstract}

%---------------------------------------------------------------------
%  目录页
%---------------------------------------------------------------------
\tableofcontents % 生成目录

%---------------------------------------------------------------------
%  第一章
%---------------------------------------------------------------------
\chapter{设计目标}
\setcounter{page}{1}
\begin{spacing}{1.5}
\songti\zihao{-4}

\section{输出指标}
本节主要是对雷达信号处理分系统的设计指标进行确认，确定设计输出的指标之后，才能够更好的针
对设计指标进行软件设计和规划。
\begin{figure}[hbtp]
    \centering
    \includegraphics [width=0.5\textwidth]{figure//output.png}
    \caption{信处输出原始产品}\label{output}
\end{figure}
在图1.1中根据《X波段双偏振天气雷达改造升级项目立项报告》列了一下信处分系统应该要输出的原
始产品。


\section{硬件架构}
目前硬件架构已经基本确认，具体如图1.2所示主要采用AD板+接口板+X86板的方案。AD板与接口板
之间采用SIRO接口连接，接口板与X86板之间采用PCIe3.0接口连接。如图所示，AD板主要负责下变
频、抽取、滤波等工作，接口板则负责接收AD板采集的数据，然后对数据进行DBF、脉冲压缩等处理，
同时需要控制伺服、波控等组件,X86板则接收接口板处理后的数据做后半段的信号数据处理，最终输
出上一节中提到的输出指标。
\begin{figure}[hbtp]
    \centering
    \includegraphics [width=0.8\textwidth]{figure//HardDesign.pdf}
    \caption{硬件设计}\label{HardDesign}
\end{figure}

因本文主要讨论软件的设计实现，主要会聚焦于X86板的信号处理部分，目前接口板与X86板的数据通
道已经是对接过，可以从接口板读取相关数据,后续的工作便是两个主要的工作：
\begin{itemize}
    \itemsep=3pt
    \parskip=0pt
    \setlength{\itemindent}{1em}
    \item 设计接口板与X86板接收数据的协议
    \item 处理理接收到的数据
\end{itemize}


%\begin{table}[hbtp]
%	\centering
%	\caption{软件功能要求}
%	\begin{tabular}{lp{3cm}p{4cm}p{4cm}}
%	\hline
%	模块    & 软件            & 功能                 &         备注\\
%	\hline
%    \multirow{2}{*}{网关}     & 系统软件& 网关的基本通信功能& 基于Openwrt开源系统\\
%    %\cline{2-4}
%	~  & 远程控制软件    & 设备远程配置       & 基于curl工具进行开发\\
%    %\hline
%
%    服务器  & 服务器软件  & 采集数据建立通信通道 & 定制开发\\
%    %\hline          
%
%	管理软件    & 设备管理软件 & 管理网关和设备     & 使用浏览器远程登录服务器 \\
%	\hline          
%	\end{tabular}
%	\label{tab:Cost_evalua}
%\end{table}

\end{spacing}

%---------------------------------------------------------------------
%  第二章
%---------------------------------------------------------------------
\chapter{设计原理}
\begin{spacing}{1.5}
\songti\zihao{-4}

\section{数据模型}
\subsection{三维数据模型}
需要对雷达回波进行数据处理，首先要将回波数据抽象成一个数据处理模型，在这里采用了三维数据
块作为一个数据处理模型\cite{FundamentalsOfRadarSignalProcessing},这一处理方法引用自
雷达信号处理基础第三章，基本处理模型如图2.1所示：
\begin{figure}[hbtp]
    \centering
    \includegraphics [width=1.0\textwidth]{figure//DataBlock.pdf}
    \caption{信号处理数据块}\label{DataBlock}
\end{figure}

可以看到,在上图中的x轴方向标注为快时间维度，本质就是一个PRI(脉冲重复间隔)内的回波
采样数据.y轴标注为慢时间维度，本质是一个CPI(相干处理间隔)内的多组回波数据。z轴标注的是
接收通道维度，本质就是对应天线的接收通道数目。

\subsection{数据模型理解}
上一节是介绍了基本的数据模型，在本节中还需要深入的理解一下设计的数据模型，在图2.2中，针
对数据模型的三个维度进行了进一步的标注。
\begin{figure}[hbtp]
    \centering
    \includegraphics [width=1.0\textwidth]{figure//DataBlock2.pdf}
    \caption{信号处理数据块}\label{DataBlock2}
\end{figure}

x轴方向标注为距离采样l，脉冲压缩处理便是在这一维度做处理，而多普勒处理则是沿y轴方向，y轴
方向还有一个很重要的含义，便是脉冲发射后经历相同时延接收到的回波，z轴代表不同的接收通道，
不同的接收通道具有不同的相位，波束赋形便是在z轴方向来处理的。

在这里我们将一个接收通道的采样数据拿出来详细研究一下，如图2.3所示，将x轴和y轴方向的数据
转换到时间轴，一个距离库对应一个小方块,同时对应的就是一个采样周期内的采样数据，一列数据
便是一个PRT内采集到的数据，而一个CPI内的数据，则是多个PRT内的数据采集到一起进行数据处理。

\begin{figure}[H]
    \centering
    \includegraphics [width=1.0\textwidth]{figure//CPIdata.pdf}
    \caption{CPI数据}\label{CPIdata}
\end{figure}

根据上面两节的叙述基本建立了一个数据处理的模型，后面的计算和处理均会在这个三维模型来进行
展开。

\section{指标算法}
有了数据处理模型，还需要知道如何处理这个数据模型，现在就像做菜，菜的原材料已经有了，但是
还需要食谱，然后根据食谱做出想吃的菜，本节就是描述如何进行处理这些原材料。首先需要面对的
就是3个最基本的指标，反射率强度(Z)，径向速度(V)，速度谱宽(W)，下面就逐个指标来进行计算。

\subsection{反射率强度}
反射率强度(Z)是雷达回波的最基本指标，在这里主要引用
《雷达信号处理基础(第二版)》\cite{FundamentalsOfRadarSignalProcessing}中2.2.4节中的
计算模型，雷达气象学通常采用称为反射率的归一化因子来表示气象目标的散射特性，通常用Z表示,
体反射率(RCS)公式如下:

\begin{proposition}[体反射率]

    \begin{equation}
        \eta=\frac{\pi^5|K|^2}{\lambda}Z
    \end{equation}

    $|K^2|$:对于由水构成的散射体其值近似为0.93，由冰构成的散射体近似为0.197

    $\lambda$:雷达波长

\end{proposition}

当给出一个回波功率测量值，就可以用雷达方程估计出$\eta$，然后利用公式2.1换算成Z，再
对取10lgZ即得到dBZ。

《雷达信号处理基础(第二版)》\cite{FundamentalsOfRadarSignalProcessing}中2.2.2节给出
的体散射目标的雷达方程如下：
\begin{proposition}[体散射雷达方程]

    \begin{equation}
        p_r\left(t_0\right)=\frac{P_tG^2\lambda^2\eta\Delta R\theta_3\phi_3}{
                            \left(4\pi\right)^3R_0^2L_sL_a\left(R_0\right)}
    \end{equation}

    $p_r(t_0)$:$t_0$时刻回波接收功率

    $P_t$:雷达辐射功率

    $G$:天线增益

    $\lambda$:雷达波长

    $\Delta R$:一个距离分辨单元的长度

    $\theta_3$:方位3dB波束宽度

    $\phi_3$:俯仰3dB波束宽度

    $R_0$:分辨单元中心距离

    $L_s$:系统损耗因子

    $L_a(R_0)$:$R_0$处的大气衰减
\end{proposition}

根据公式2.1和2.2便可以解出Z，综合后的公式如下：
\begin{proposition}[体散射雷达方程]

    \begin{equation}
        Z=\frac{64}{\pi^2}*\frac{L_sL_a\left(R_0\right)}
            {P_tG^2\lambda|K|^2\Delta R\theta_3\phi_3}*R_0^2P_r(t_0)
    \end{equation}

\end{proposition}

根据公式2.3可以看出只要从上一节中的距离库获取$R_0$和$P_r(t_0)$便可以解出Z的值，公式中
的其它部分则可以根据相关的系统属性计算为一个常数。

$R_0$的值是比较好计算的，直接使用下面的公式：
\begin{proposition}[目标距离计算]

    \begin{equation}
        R_0=\frac{c*t_0}{2} 
    \end{equation}

    $c$:光速

    $t_0$:接收机接收回波的时间

\end{proposition}

下面重点介绍一下$P_r(t_0)$的计算，为了得到更好的信噪比，回波功率需要在一个CPI上来计算信
号功率，相干积累可以增加信噪比主要源于下面三个公式。

\begin{proposition}[相干积累]

    \begin{equation}
        \chi_1=\frac{A^2}{\sigma_w^2}
    \end{equation}

    \begin{equation}
        \sum_{n=0}^{N-1}\left\{Ae^{j\phi}+w\left[n\right]\right\}=NAe^{j\phi}+\sum_{n=0}^{N-1}w\left[n\right]
    \end{equation}

    \begin{equation}
        \chi_N=\frac{(NA)^2}{N\sigma_w^2}=N\chi_1
    \end{equation}

    $\chi_1$:单脉冲的SNR

    $A$:复回波$Ae^{j\phi}$的幅度值

    $\Sigma_w^2$:高斯白噪声的信号功率

    $w[n]$:噪声信号

    $\chi_N$:N个相干信号累计的SNR

\end{proposition}

根据相干积累公式中的原理，采样得到的总功率等于有效回波信号的功率加上噪声功率，而每个距离
库采样信号的值表示为I+jQ两路的数据，总功率可以通过$\sqrt{I^2+Q^2}$来计算。又根据相干积
累中信噪比可以提升N倍，这样有利于判断是否接收到的信号为有效的回波，当然为了计算接收回波的
功率，还需要计算噪声的功率。

噪声功率的计算方法:取最大俯仰角的接收通道，最远距离的256个距离库计算平均功率。

有了总功率和噪声功率，很自然便可以得到回波信号的功率$P_r(to)$。

\subsection{径向速度} 
径向速度的计算主要在慢时间维度(即数据块的y轴方向)进行处理，处理的原理主要是基于多普勒定律，
针对我司的气象雷达信号处理中多普勒处理主要有以下两个个方法：
\begin{enumerate}[1)]
    \itemindent=2em
    \item MTI(运动目标指示)
    
    \qquad MTI处理的目的主要是设计一个高通滤波器滤除杂波,如图2.4所示，

    \begin{figure}[hbtp]
    \centering
    \includegraphics [width=1.0\textwidth]{figure//MTI.pdf}
    \caption{MIT处理}\label{MTI}
    \end{figure}

    \item 脉冲对处理(PPP)\cite{FundamentalsOfRadarSignalProcessing}\cite{radarmeter}
    \cite{RadarManual}在气象雷达中脉冲对处理主要是为了计算目标谱峰的参数，速度计算如公式6
    所示，处理原理主要是依据目标速度比较慢，频谱偏移比较小，采用计算相位的办法更为合适，
    具体的阐述可以看引用网页\cite{dopler.web},在上面做了比较清晰的解释。

    具体的推导原理就是根据图2.5。
    \begin{figure}[hbtp]
        \centering
        \includegraphics [width=1.0\textwidth]{figure//pulse.png}
        \caption{相位计算}\label{pulse}
    \end{figure}

    根据图中所示，做如下推导：

    \begin{proposition}[相位计算推导公式]
        
        \begin{equation}
            \phi = \phi_0 +　\frac{4\pi r}{\lambda}
        \end{equation}

        $\phi_0$:发射信号的相位

        $\phi$:接收信号的相位

        等式两边做微分可得：

        \begin{equation}
            \frac{d\phi}{dt}=\frac{4\pi}{\lambda}\frac{dr}{dt}
        \end{equation}

        $dt$:dt就是两个采样之间的时间间隔T

        $\frac{dr}{dt}$:就是速度V

        \begin{equation}
           V=\frac{\lambda}{4\pi T}d\phi
        \end{equation}

    \end{proposition}

    在这里主要希望计算的是相位的变化。

    \begin{proposition}[速度计算公式\cite{RadarManual}]

    \begin{equation}
        R[T]=\frac{1}{N}\sum_{k=0}^{N-1}s[k+1]s^*[k]
    \end{equation}

    \begin{equation}
        V_0=\frac{\lambda}{4\pi T}arg\left\{R(T)\right\}
    \end{equation}

    $R(T)$:相邻两个脉冲的自相关函数

    $s_k$:复通向(I)和正交(Q)信号样本

    $V_0$:径向速度

    $P_n$:噪声功率

    $T$:连续两次取样的时间间隔

    $\lambda$:波长

    \end{proposition}

\end{enumerate}

\subsection{速度谱宽}

计算出径向速度之后，也可以使用自相关函数计算出谱宽，谱宽计算在这里直接采用雷达手册中给出
的公式,如公式7所示。

    \begin{proposition}[谱宽计算公式\cite{RadarManual}]

    \begin{equation}
        \sigma^2\approx\frac{\lambda}{8\pi^2 T^2}arg\left\{1-\frac{R(T)}{R(0)-P_n}\right\}
    \end{equation}

    $R(T)$:相邻两个脉冲的自相关函数

    $R(0)$:相当于将自己与自己的复共轭相乘之后除以N

    $s_k$:复通向(I)和正交(Q)信号样本

    $V_0$:径向速度

    $T$:连续两次取样的时间间隔

    $\lambda$:波长

    \end{proposition}

\end{spacing}

%---------------------------------------------------------------------
%  第三章 模块设计
%---------------------------------------------------------------------
\chapter{设计实现}
\begin{spacing}{1.5}
\songti\zihao{-4}

上一章主要讨论了雷达回波几个关键参数的处理原理，这一章主要讲的是结合硬件设备的软件实现。
首先需要考虑的问题便是数据的获取，其次便是如何处理数据。
\section{数据获取}
\subsection{数据接收}
在第一章的硬件框图中可以看到，x86板主要通过PCIe接口从FPGA接收数据，接收数据的过程中，主
要需要考虑的就是接受的数据的数据量大小，而接收数据量大小又和发射脉冲、接收通道等有关，下
面列出了一个单通道一个CPI数据量评估公式：

    \begin{proposition}[数据量算公式]

    \begin{equation}
        Data=4L_{dist}*C_{prt}+C_{prt}*H
    \end{equation}

    $4$:表示需要4个字节用来存放IQ两路采样数据

    $L_{dist}$:距离库数目，根据探测距离决定

    $C_prt$:PRT个数，在我司研发的系统中采用的是64个PRT

    $H$:每个距离库的头部信息字节数

    \end{proposition}

这里可以大概根据公式评估数据量，假设$L_{dist}$值为1500，H为64字节，则大致可以计算出一个
CPI内单通道数据为379KByte。

目前PCIe驱动已经完成了调试，接收数据通道目前基本已经打通。

\subsection{数据存储}
    完成数据的接收之后，主要考虑的是数据要按照计算要求进行存储，以便于进行数据处理。讨论
到计算处理，需要先来看一下结构。

\section{数据处理}


\end{spacing}

%---------------------------------------------------------------------
%  第四章 详细设计
%---------------------------------------------------------------------
\chapter{详细设计}
\begin{spacing}{1.5}       

\section{协议设计}

\section{软件框架}

\end{spacing}
%---------------------------------------------------------------------
%  第五章 总结
%---------------------------------------------------------------------
\chapter{总结}
\begin{spacing}{1.5}       
    整个网关网络管理还是比较纷繁复杂的，主要是因为设备分散，且网关后面又连接了一定数量的
    子设备，且网关一般是位于内网，需要穿透公网对网络设备进行网络管理和配置，本文基于功能
    设计。
\end{spacing}

%---------------------------------------------------------------------
%  参考文献设置
%---------------------------------------------------------------------
\addcontentsline{toc}{chapter}{参考文献}

\begin{thebibliography}{99}
\songti \zihao{-4} 	
    \bibitem{FundamentalsOfRadarSignalProcessing}
    Mark A.Richards . 雷达信号处理基础 (第二版) [M]. 2008.
    \bibitem{radarmeter}
    张培昌. 雷达气象学[M]. 气象出版社, 1988.
    \bibitem{dopler.web}
    http://apollo.lsc.vsc.edu/classes/remote/lecture\_notes/radar/doppler/two\_pulses.html
    \bibitem{RadarManual}
    斯科尼克(Skolnik,M.I.) 雷达手册: 第3版/(美) 南京电子研究所, 2010.

\end{thebibliography}

\end{document}